<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Jared | Forsyth
    </title>    <link rel="stylesheet" href="/media/bootstrap/css/bootstrap.css"/>
    <link rel="stylesheet" href="/media/css/general.css"/>
<link rel="stylesheet" href="/media/css/header.css"/>
<link rel="stylesheet" href="/media/css/blog-post.css"/>
  </head>
  <body class=""><div id="header" class="clearfix">
  <div class="title">Jared Forsyth
  </div>
  <div class="nav-internal"><nav class=nav nav-pills>
    <ul class="nav nav-pills">
                <li>
            <a title="Home Page"
                class="button white home"
                                                href="/index.html"
                                >
                home
            </a>
        </li>        <li>
            <a title="Projects"
                class="button white projects"
                                                href="/projects"
                                >
                projects
            </a>
        </li>        <li>
            <a title="Blog"
                class="button white blog"
                                                href="/blog"
                                >
                blog
            </a>
        </li>        <li>
            <a title="About"
                class="button white about"
                                                href="/about.html"
                                >
                about
            </a>
        </li>    </ul>
</nav>
  </div>
  <div class="nav-external"><nav class=nav nav-pills>
    <ul class="nav nav-pills">
                <li>
            <a title="my github repositories"
                class="button white github"
                                target="_blank"
                                                href="/http%3A//github.com/jabapyth"
                                >
                github
            </a>
        </li>        <li>
            <a title="my twitter account"
                class="button white twitter"
                                target="_blank"
                                                href="/http%3A//twitter.com/jabapyth"
                                >
                twitter
            </a>
        </li>        <li>
            <a title="my linkedin profile"
                class="button white linkedin"
                                target="_blank"
                                                href="/http%3A//www.linkedin.com/profile/view%3Fid%3D37203333"
                                >
                linkedin
            </a>
        </li>        <li>
            <a title="my stackoverflow profile"
                class="button white stackoverflow"
                                target="_blank"
                                                href="/http%3A//stackoverflow.com/users/290784/jared-forsyth"
                                >
                stackoverflow
            </a>
        </li>    </ul>
</nav>
  </div>
</div><div id="content">
<article class="post">
<nav class="post_nav">
<a class="backlink" href="/blog/2010/jul/28">Back to list</a>
<a class="prev"
    title="CodeTalker by example: translate"
        href="/blog/2010/jul/29/codetalker-example-translate.html">
    Previous
</a>

<a class="next"
    title="CodeTalker by example: tokenize"
        href="/blog/2010/jul/27/codetalker-example-tokenize.html">
    Next
</a>

</nav>
<h1 class="title">
    <a href="/blog/2010/jul/28/codetalker-example-parse.html">
        CodeTalker by example: parse
    </a>
</h1>
<time datetime="2010-07-28">
    Posted: Wed, 28 Jul 2010
</time>


<div class="document">
<p>This is the second in a four-part series, in which I demonstrate how to build a
<span class="caps">CSS</span> parser using <a class="reference external" href="http://jaredforsyth.com/projects/codetalker/">CodeTalker</a>:</p>
<ul class="simple">
<li><a class="reference external" href="http://jaredforsyth.com/blog/2010/jul/27/codetalker-example-tokenize/">tokenize</a></li>
<li><strong>parse</strong></li>
<li><a class="reference external" href="http://jaredforsyth.com/blog/2010/jul/29/codetalker-example-translate/">translate</a></li>
<li><a class="reference external" href="http://jaredforsyth.com/blog/2010/jul/29/codetalker-example-test/">test!</a></li>
</ul>
<p>To get the code for&nbsp;this:</p>
<p><tt class="docutils literal">git clone</tt> <a class="reference external" href="http://github.com/jabapyth/css/">git://github.com/jabapyth/css.git</a></p>
<div class="section" id="parsing">
<h1>Parsing</h1>
<p>In this section we actually define the grammar and the <span class="caps">AST</span> attributes.
Fortunately for someone has already gone to the trouble of specifying <span class="caps">CSS2</span> as
a <span class="caps">CFG</span>, and the process of transforming their <span class="caps">EBNF</span> to CodeTalker is relatively&nbsp;straight-forward.</p>
<p><em>[for the impatient, you can just look at the</em> <a class="reference external" href="http://github.com/jabapyth/css/blob/master/css/grammar.py">final code</a> <em>].</em></p>
<p>I should mention that <strong><span class="caps">CSS</span> is an interesting case, as far as grammars go</strong>.
With its case-insensitivity, ambiguous tokens (<tt class="docutils literal">#<span class="caps">FFF</span></tt> could either be a
color or a node id depending on the placement), and permissive error handling
(you&#8217;re supposed to &#8220;just ignore anything you don&#8217;t understand&#8221;), it proves
an interesting challange for a world which usually avoids ambiguity and spits
out a &#8220;Syntax Error&#8221; at the first sign of&nbsp;trouble.</p>
<div class="section" id="confession">
<h2>Confession</h2>
<p><em>But</em> before we begin the main grammar, I have to address an aspect of <span class="caps">CSS</span> that I
conveniently failed to mention during the tokenization stage; <span class="caps">CSS</span> identifiers
<strong>can contain a hyphen</strong>, and therefore aren&#8217;t fully covered by the baked-in
<span class="caps">ID</span>&nbsp;token.</p>
<p>It can&#8217;t even be fixed by using the <tt class="docutils literal">idchars</tt> option, because then a single
hyphen could be considered an <span class="caps">ID</span>, which wouldn&#8217;t work&nbsp;out.</p>
<p>Now, in my first version of this code, I just used a&nbsp;regexp</p>
<blockquote>
<tt class="docutils literal"><span class="pre">(-\w+)+|\w+(-\w+)*</span></tt></blockquote>
<p>but for performance reasons, I chose to handle this
special aspect of IDs in a grammar rule. So here it&nbsp;is:</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">cssid</span><span class="punctuation">(</span><span class="name">rule</span><span class="punctuation">):</span>
    <span class="name">ids</span> <span class="operator">=</span> <span class="name"><span class="caps">ID</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">COLOR</span></span><span class="punctuation">,</span> <span class="name">NODE_NAME</span><span class="punctuation">,</span> <span class="name"><span class="caps">UNIT</span></span>
    <span class="name">rule</span> <span class="operator">|</span> <span class="name">plus</span><span class="punctuation">(</span><span class="literal string">'-'</span><span class="punctuation">,</span> <span class="name">_or</span><span class="punctuation">(</span><span class="operator">*</span><span class="name">ids</span><span class="punctuation">))</span> <span class="operator">|</span> <span class="punctuation">(</span><span class="name">_or</span><span class="punctuation">(</span><span class="operator">*</span><span class="name">ids</span><span class="punctuation">),</span> <span class="name">star</span><span class="punctuation">(</span><span class="literal string">'-'</span><span class="punctuation">,</span> <span class="name">_or</span><span class="punctuation">(</span><span class="operator">*</span><span class="name">ids</span><span class="punctuation">)))</span>
    <span class="name">rule</span><span class="operator">.</span><span class="name">dont_ignore</span> <span class="operator">=</span> <span class="name builtin pseudo">True</span>
    <span class="name">rule</span><span class="operator">.</span><span class="name">astAttrs</span> <span class="operator">=</span> <span class="punctuation">{</span><span class="literal string">'parts'</span><span class="punctuation">:</span> <span class="punctuation">(</span><span class="name"><span class="caps">SYMBOL</span></span><span class="punctuation">,</span> <span class="punctuation">)</span> <span class="operator">+</span> <span class="name">ids</span><span class="punctuation">}</span>
</pre>
<!-- yeah* -->
<p>The <tt class="docutils literal">ids</tt> variable is a list of all tokens that could concievably match
<em>part</em> of a token; e.g. <tt class="docutils literal"><span class="pre">green-div-baz</span></tt> would be tokenized <tt class="docutils literal">[<span class="caps">COLOR</span>, <span class="caps">SYMBOL</span>,
NODE_NAME, <span class="caps">SYMBOL</span>, <span class="caps">ID</span>]</tt></p>
<p>Also of note is the <tt class="docutils literal">dont_ignore</tt> flag; normally, whitespace, newlines, and
comments are ignored while parsing grammar rules (for this grammar, anyway),
which is the behavior you&#8217;d expect. For this one rule, however, we don&#8217;t want&nbsp;to.</p>
</div>
<div class="section" id="grammar-rules">
<h2>Grammar&nbsp;Rules</h2>
<p>Aaaand on to the normal stuff. Here&#8217;s the <tt class="docutils literal">stylesheet</tt> rule (which will be
our starting&nbsp;rule):</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">style_sheet</span><span class="punctuation">(</span><span class="name">rule</span><span class="punctuation">):</span>
    <span class="name">rule</span> <span class="operator">|</span> <span class="punctuation">([</span><span class="name">charset</span><span class="punctuation">],</span> <span class="name">star</span><span class="punctuation">(</span><span class="name">import_</span><span class="punctuation">),</span> <span class="name">star</span><span class="punctuation">(</span><span class="name">section</span><span class="punctuation">))</span>
    <span class="name">rule</span><span class="operator">.</span><span class="name">astAttrs</span> <span class="operator">=</span> <span class="punctuation">{</span>
            <span class="literal string">'charset'</span><span class="punctuation">:</span> <span class="name">charset</span><span class="punctuation">,</span>
            <span class="literal string">'imports'</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="name">import_</span><span class="punctuation">],</span>
            <span class="literal string">'sections'</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="name">section</span><span class="punctuation">],</span>
        <span class="punctuation">}</span>
</pre>
<p>Pretty normal. (if this looks confusing to you, take a look at the <a class="reference external" href="http://jaredforsyth.com/blog/2010/jul/26/only-codetalker-introduction-youll-ever-need/">CodeTalker
reference</a>)</p>
<p>But I won&#8217;t bore you with the details â€” you could just look at <a class="reference external" href="http://github.com/jabapyth/css/blob/master/css/grammar.py">the code</a> for&nbsp;that.</p>
<p>Here are some&nbsp;highlights:</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">charset</span><span class="punctuation">(</span><span class="name">rule</span><span class="punctuation">):</span>
    <span class="name">rule</span> <span class="operator">|</span> <span class="punctuation">(</span><span class="name">no_ignore</span><span class="punctuation">(</span><span class="literal string">'&#64;'</span><span class="punctuation">,</span> <span class="literal string">'charset'</span><span class="punctuation">),</span> <span class="name">_or</span><span class="punctuation">(</span><span class="name"><span class="caps">STRING</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">SSTRING</span></span><span class="punctuation">),</span> <span class="literal string">';'</span><span class="punctuation">)</span>
    <span class="name">rule</span><span class="operator">.</span><span class="name">astAttrs</span> <span class="operator">=</span> <span class="punctuation">{</span>
        <span class="literal string">'charset'</span><span class="punctuation">:{</span><span class="literal string">'type'</span><span class="punctuation">:[</span><span class="name"><span class="caps">STRING</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">SSTRING</span></span><span class="punctuation">],</span> <span class="literal string">'single'</span><span class="punctuation">:</span><span class="name builtin pseudo">True</span><span class="punctuation">}</span>
    <span class="punctuation">}</span>
</pre>
<p>The <tt class="docutils literal">no_ignore</tt> function indicates that, during the parsing of this
sequence no tokens should be ignored. It&#8217;s like the <tt class="docutils literal">dont_ignore</tt> rule flag,
but for a&nbsp;sequence.</p>
</div>
<div class="section" id="permissive-syntax">
<h2>Permissive&nbsp;Syntax</h2>
<p>In order to address the <strong>just ignore any syntax errors, and do your best</strong>
<a class="reference external" href="http://www.w3.org/TR/2008/REC-CSS2-20080411/syndata.html#parsing-errors">rule of <span class="caps">CSS</span> parsing</a>, I
made an addition to the <tt class="docutils literal">declaration</tt> rule.</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">declaration</span><span class="punctuation">(</span><span class="name">rule</span><span class="punctuation">):</span>
    <span class="name">rule</span> <span class="operator">|</span> <span class="punctuation">(</span><span class="name">cssid</span><span class="punctuation">,</span> <span class="literal string">':'</span><span class="punctuation">,</span> <span class="name">plus</span><span class="punctuation">(</span><span class="name">value</span><span class="punctuation">),</span> <span class="punctuation">[</span><span class="name">important</span><span class="punctuation">],</span> <span class="literal string">';'</span><span class="punctuation">)</span>
    <span class="name">rule</span> <span class="operator">|</span> <span class="punctuation">(</span><span class="name">plus</span><span class="punctuation">(</span><span class="name">_not</span><span class="punctuation">(</span><span class="name">_or</span><span class="punctuation">(</span><span class="literal string">';'</span><span class="punctuation">,</span> <span class="literal string">'}'</span><span class="punctuation">))),</span> <span class="literal string">';'</span><span class="punctuation">)</span>
    <span class="name">rule</span><span class="operator">.</span><span class="name">astAttrs</span> <span class="operator">=</span> <span class="punctuation">{</span>
        <span class="literal string">'property'</span><span class="punctuation">:</span><span class="name">cssid</span><span class="punctuation">,</span>
        <span class="literal string">'values'</span><span class="punctuation">:[</span><span class="name">value</span><span class="punctuation">],</span>
        <span class="literal string">'important'</span><span class="punctuation">:</span><span class="name">important</span><span class="punctuation">,</span>
    <span class="punctuation">}</span>
</pre>
<p>Essentially, &#8220;first try to make some sense of it, and if that fails, consume
tokens up to the next &#8216;;&#8217; or &#8216;}&#8217;&#8221;. In the second case, the <span class="caps">AST</span> attributes will
be&nbsp;None/empty.</p>
<p>Anyway, I think that pretty much sums up what I wanted to focus on. Any
questions? comments? Shakespeare&nbsp;quotations?</p>
</div>
</div>
</div>

</article>

<div class="post-comments">
    <a name="comments"></a>
    <script>
        var disqus_identifier = "codetalker-example-parse";
    </script>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
    /**
    * var disqus_identifier; [Optional but recommended: Define a unique
    * identifier (e.g. post id or slug) for this thread] 
    */
    (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://jaredforsyth.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=jaredforsyth">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

</div>
</div>  </body>
</html>