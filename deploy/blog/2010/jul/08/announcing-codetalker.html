<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Jared | Forsyth
    </title>    <link rel="stylesheet" href="/media/bootstrap/css/bootstrap.css"/>
    <link rel="stylesheet" href="/media/css/general.css"/>
<link rel="stylesheet" href="/media/css/header.css"/>
<link rel="stylesheet" href="/media/css/blog-post.css"/>
  </head>
  <body class=""><div id="header" class="clearfix">
  <div class="title">Jared Forsyth
  </div>
  <div class="nav-internal"><nav class=nav nav-pills>
    <ul class="nav nav-pills">
                <li>
            <a title="Home Page"
                class="button white home"
                                                href="/index.html"
                                >
                home
            </a>
        </li>        <li>
            <a title="Projects"
                class="button white projects"
                                                href="/projects"
                                >
                projects
            </a>
        </li>        <li>
            <a title="Blog"
                class="button white blog"
                                                href="/blog"
                                >
                blog
            </a>
        </li>        <li>
            <a title="About"
                class="button white about"
                                                href="/about.html"
                                >
                about
            </a>
        </li>    </ul>
</nav>
  </div>
  <div class="nav-external"><nav class=nav nav-pills>
    <ul class="nav nav-pills">
                <li>
            <a title="my github repositories"
                class="button white github"
                                target="_blank"
                                                href="/http%3A//github.com/jabapyth"
                                >
                github
            </a>
        </li>        <li>
            <a title="my twitter account"
                class="button white twitter"
                                target="_blank"
                                                href="/http%3A//twitter.com/jabapyth"
                                >
                twitter
            </a>
        </li>        <li>
            <a title="my linkedin profile"
                class="button white linkedin"
                                target="_blank"
                                                href="/http%3A//www.linkedin.com/profile/view%3Fid%3D37203333"
                                >
                linkedin
            </a>
        </li>        <li>
            <a title="my stackoverflow profile"
                class="button white stackoverflow"
                                target="_blank"
                                                href="/http%3A//stackoverflow.com/users/290784/jared-forsyth"
                                >
                stackoverflow
            </a>
        </li>    </ul>
</nav>
  </div>
</div><div id="content">
<article class="post">
<nav class="post_nav">
<a class="backlink" href="/blog/2010/jul/08">Back to list</a>
<a class="prev"
    title="JSON parsing in python"
        href="/blog/2010/jul/08/json-parsing-python.html">
    Previous
</a>

<a class="next"
    title="String concatenation kills babies"
        href="/blog/2010/jun/26/string-concatenation-kills-babies.html">
    Next
</a>

</nav>
<h1 class="title">
    <a href="/blog/2010/jul/08/announcing-codetalker.html">
        Announcing: Codetalker
    </a>
</h1>
<time datetime="2010-07-08">
    Posted: Thu, 08 Jul 2010
</time>


<div class="document">
<img alt="http://jaredforsyth.com/media/projects/navajo.gif" src="http://jaredforsyth.com/media/projects/navajo.gif" />
<div class="section" id="introduction">
<h1>Introduction</h1>
<p>Well, I&#8217;ve done it again. I&#8217;ve put off blogging about a project for so long that it is impossible for me to do justice to all the cool things that have been going on; so I&#8217;ll skip most of&nbsp;it.</p>
<p><strong>Codetalker</strong> is a project that has actually been bubbling away on my back burner for probably over a year now, and which has seen its share of complete overhauls, but which I think is now ready to come into the&nbsp;light.</p>
<p><a class="reference external" href="http://jaredforsyth.com/projects/codetalker/">Codetalker</a> takes much of its design inspiration from the excellent documentation python has of its <a class="reference external" href="http://docs.python.org/reference/grammar.html">Official Grammar</a> and the <a class="reference external" href="http://docs.python.org/library/ast.html#abstract-grammar">&#8220;Abstract Grammar&#8221;</a> defined in the <span class="caps">AST</span> module. While creating Codetalker, I looked at those two documents and thought &#8220;there&#8217;s no reason why defining a parser should be any harder than&nbsp;this.&#8221;</p>
<p>Of course, I am well aware that This Has Been Done Before. I&#8217;ve looked at many solutions, and been unsatisfied with all (obviously, as I&#8217;ve decided to make my&nbsp;own).</p>
<p>One problem with many existing solutions is that they are limited in power and flexibility by a reliance on a <a class="reference external" href="http://en.wikipedia.org/wiki/Domain-specific_language"><span class="caps">DSL</span></a> (often <a class="reference external" href="http://en.wikipedia.org/wiki/Backus%E2%80%93Naur_Form"><span class="caps">BNF</span>-like</a>) for grammar definition. This is where codetalker started as well, but one of the chief things that bugged me was the fact that whichever system I used, it was both rigid and arbitrary. I wrote grammar-parsers for several different forms before deciding that <em>there had to be a better way</em>.</p>
<p>And there was. &#8220;Who am I to reinvent the wheel?&#8221; I asked (conveniently forgetting that I have, on many occasions, done just that). So I went back to python. Flexible? Totally. Powerful? Definitely. Capable? Of course. And doing everything in python allowed me to avoid the kind of frankinsteined mashups that are <span class="caps">ANTLR</span> grammar&nbsp;definitions.</p>
</div>
<div class="section" id="parsing">
<h1>Parsing</h1>
<p>To whet your palate, here&#8217;s what a <span class="caps">JSON</span> parser looks&nbsp;like:</p>
<div class="section" id="example">
<h2>Example</h2>
<pre class="code python literal-block">
<span class="comment"># rules (value is the start rule)</span>
<span class="keyword">def</span> <span class="name function">value</span><span class="punctuation">(</span><span class="name">rule</span><span class="punctuation">):</span>
    <span class="name">rule</span> <span class="operator">|</span> <span class="name">dict_</span> <span class="operator">|</span> <span class="name">list_</span> <span class="operator">|</span> <span class="name"><span class="caps">STRING</span></span> <span class="operator">|</span> <span class="name"><span class="caps">TFN</span></span> <span class="operator">|</span> <span class="name"><span class="caps">NUMBER</span></span>
    <span class="name">rule</span><span class="operator">.</span><span class="name">pass_single</span> <span class="operator">=</span> <span class="name builtin pseudo">True</span>

<span class="keyword">def</span> <span class="name function">dict_</span><span class="punctuation">(</span><span class="name">rule</span><span class="punctuation">):</span>
    <span class="name">rule</span> <span class="operator">|</span> <span class="punctuation">(</span><span class="literal string">'{'</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="name">commas</span><span class="punctuation">((</span><span class="name"><span class="caps">STRING</span></span><span class="punctuation">,</span> <span class="literal string">':'</span><span class="punctuation">,</span> <span class="name">value</span><span class="punctuation">))],</span> <span class="literal string">'}'</span><span class="punctuation">)</span>
    <span class="name">rule</span><span class="operator">.</span><span class="name">astAttrs</span> <span class="operator">=</span> <span class="punctuation">{</span><span class="literal string">'keys'</span><span class="punctuation">:</span> <span class="name"><span class="caps">STRING</span></span><span class="punctuation">,</span> <span class="literal string">'values'</span><span class="punctuation">:</span> <span class="name">value</span><span class="punctuation">}</span>
<span class="name">dict_</span><span class="operator">.</span><span class="name">astName</span> <span class="operator">=</span> <span class="literal string">'Dict'</span>

<span class="keyword">def</span> <span class="name function">list_</span><span class="punctuation">(</span><span class="name">rule</span><span class="punctuation">):</span>
    <span class="name">rule</span> <span class="operator">|</span> <span class="punctuation">(</span><span class="literal string">'['</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="name">commas</span><span class="punctuation">(</span><span class="name">value</span><span class="punctuation">)],</span> <span class="literal string">']'</span><span class="punctuation">)</span>
    <span class="name">rule</span><span class="operator">.</span><span class="name">astAttrs</span> <span class="operator">=</span> <span class="punctuation">{</span><span class="literal string">'values'</span><span class="punctuation">:</span> <span class="name">value</span><span class="punctuation">}</span>
<span class="name">list_</span><span class="operator">.</span><span class="name">astName</span> <span class="operator">=</span> <span class="literal string">'List'</span>

<span class="name">grammar</span> <span class="operator">=</span> <span class="name">Grammar</span><span class="punctuation">(</span><span class="name">start</span><span class="operator">=</span><span class="name">value</span><span class="punctuation">,</span>
         <span class="name">tokens</span><span class="operator">=</span><span class="punctuation">[</span><span class="name"><span class="caps">STRING</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">NUMBER</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">NEWLINE</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">WHITE</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">SYMBOL</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">TFN</span></span><span class="punctuation">],</span>
         <span class="name">ignore</span><span class="operator">=</span><span class="punctuation">[</span><span class="name"><span class="caps">WHITE</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">NEWLINE</span></span><span class="punctuation">],</span>
         <span class="name">ast_tokens</span><span class="operator">=</span><span class="punctuation">[</span><span class="name"><span class="caps">STRING</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">TFN</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">NUMBER</span></span><span class="punctuation">])</span>
</pre>
<p>And yes, that is a complete parser in 12 lines of code. [for the full json parser + translator, <a class="reference external" href="http://github.com/jabapyth/codetalker/blob/master/codetalker/contrib/json.py">check this out</a>]</p>
<p>First off, the one possibly evil thing that codetalker does is modification through the bitwise <span class="caps">OR</span> operator&#8230; Yes, traditionally one should not modify an object using infix operators, but I considered many other options and this seemed the most intuitive while mainatining brevity. [You can still do rule.add_option(&#8230;) if you&nbsp;like].</p>
</div>
<div class="section" id="grammar-sugar">
<h2>Grammar&nbsp;sugar</h2>
<p>Some of the sugar in there is the fact that a list <tt class="docutils literal">[stuff]</tt> denotes <em>optional</em> (for similarity with some <span class="caps">BNF</span> styles). For other fancy regular expression sugar, you have the special functions <tt class="docutils literal"><span class="pre">_or(&#8230;)</span></tt>, <tt class="docutils literal"><span class="pre">star(&#8230;)</span></tt>, and <tt class="docutils literal"><span class="pre">plus(&#8230;)</span></tt> which apply to <tt class="docutils literal">foo | baz</tt>, <tt class="docutils literal">foo*</tt> and <tt class="docutils literal">foo+</tt>.</p>
<p>The final piece of the definition that might look a bit strange is the <tt class="docutils literal">commas</tt> function calls. Is this special? Not really. It&#8217;s actually just a factory function &#8212; very&nbsp;straightforward:</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">commas</span><span class="punctuation">(</span><span class="name">item</span><span class="punctuation">):</span>
    <span class="keyword">return</span> <span class="punctuation">(</span><span class="name">item</span><span class="punctuation">,</span> <span class="name">star</span><span class="punctuation">(</span><span class="literal string">','</span><span class="punctuation">,</span> <span class="name">item</span><span class="punctuation">),</span> <span class="punctuation">[</span><span class="literal string">','</span><span class="punctuation">])</span>
</pre>
<p>Here&#8217;s where you can see the real power of skipping the <span class="caps">BNF</span> and defining the grammar straight in python. Another, more complex factory function is <tt class="docutils literal">binop</tt>, used in the <a class="reference external" href="http://github.com/jabapyth/codetalker/blob/master/codetalker/contrib/math.py">math.py example grammar</a>. (both <tt class="docutils literal">binop</tt> and <tt class="docutils literal">commas</tt> are defined in <a class="reference external" href="http://github.com/jabapyth/codetalker/blob/master/codetalker/pgm/special.py">codetalker/pgm/special.py</a>)</p>
<p>The <strong>entire parser</strong> for mathematical expressions is 2 lines long, thanks to <tt class="docutils literal">binop</tt>:</p>
<pre class="code python literal-block">
<span class="name">expression</span> <span class="operator">=</span> <span class="name">binop</span><span class="punctuation">(</span><span class="name builtin">list</span><span class="punctuation">(</span><span class="literal string">'-+'</span><span class="punctuation">),</span> <span class="name builtin">list</span><span class="punctuation">(</span><span class="literal string">'*/%'</span><span class="punctuation">),</span>
          <span class="punctuation">[</span><span class="literal string">'**'</span><span class="punctuation">],</span> <span class="name">value</span><span class="operator">=</span><span class="name"><span class="caps">NUMBER</span></span><span class="punctuation">,</span> <span class="name">ops_token</span><span class="operator">=</span><span class="name"><span class="caps">OP</span></span><span class="punctuation">,</span>
          <span class="name">name</span><span class="operator">=</span><span class="literal string">'BinOp'</span><span class="punctuation">,</span> <span class="name">paren</span><span class="operator">=</span><span class="name builtin pseudo">True</span><span class="punctuation">)</span>
<span class="name">grammar</span> <span class="operator">=</span> <span class="name">pgm</span><span class="operator">.</span><span class="name">Grammar</span><span class="punctuation">(</span><span class="name">start</span><span class="operator">=</span><span class="name">expression</span><span class="punctuation">,</span>
          <span class="name">tokens</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="name"><span class="caps">OP</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">NUMBER</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">SYMBOL</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">WHITE</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">NEWLINE</span></span><span class="punctuation">],</span>
          <span class="name">ignore</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="name"><span class="caps">WHITE</span></span><span class="punctuation">,</span> <span class="name"><span class="caps">NEWLINE</span></span><span class="punctuation">],</span> <span class="name">ast_tokens</span><span class="operator">=</span><span class="punctuation">[</span><span class="name"><span class="caps">NUMBER</span></span><span class="punctuation">])</span>
</pre>
<p>The <tt class="docutils literal">binop</tt> function actually generates a grammar function as opposed to just a grammar tuple, which function is&nbsp;essentially:</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">meta</span><span class="punctuation">(</span><span class="name">rule</span><span class="punctuation">):</span>
    <span class="name">rule</span> <span class="operator">|</span> <span class="punctuation">(</span><span class="name">value</span><span class="punctuation">,</span> <span class="name">star</span><span class="punctuation">(</span><span class="name">_or</span><span class="punctuation">(</span><span class="operator">*</span><span class="name">ops</span><span class="punctuation">),</span> <span class="name">value</span><span class="punctuation">))</span>
</pre>
<p>Where <tt class="docutils literal">value</tt> is the next rule down the precedence line, and <tt class="docutils literal">ops</tt> is the list of operators at that precedence level (<tt class="docutils literal"><span class="pre">[&#8216;+&#8217;,&#8217;-&#8216;]</span></tt> for the topmost&nbsp;rule).</p>
</div>
</div>
<div class="section" id="abstract-syntax-tree">
<h1>Abstract Syntax&nbsp;Tree</h1>
<p>As any good compiler knows, parsing is nice, but not nice enough &#8212; one must take the raw parse tree (which retains all the non-essential things like spaces and comments) and generate an <a class="reference external" href="http://en.wikipedia.org/wiki/Abstract_syntax_tree">Abstract Syntax Tree</a>.</p>
<p>With Codetalker, you get this almost for free (along with&#8230;most everything else). For an example, let&#8217;s take the <tt class="docutils literal">Dict</tt> ast node from the above json&nbsp;parser.</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">dict_</span><span class="punctuation">(</span><span class="name">rule</span><span class="punctuation">):</span>
    <span class="name">rule</span> <span class="operator">|</span> <span class="punctuation">(</span><span class="literal string">'{'</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="name">commas</span><span class="punctuation">((</span><span class="name"><span class="caps">STRING</span></span><span class="punctuation">,</span> <span class="literal string">':'</span><span class="punctuation">,</span> <span class="name">value</span><span class="punctuation">))],</span> <span class="literal string">'}'</span><span class="punctuation">)</span>
    <span class="name">rule</span><span class="operator">.</span><span class="name">astAttrs</span> <span class="operator">=</span> <span class="punctuation">{</span><span class="literal string">'keys'</span><span class="punctuation">:</span> <span class="name"><span class="caps">STRING</span></span><span class="punctuation">,</span> <span class="literal string">'values'</span><span class="punctuation">:</span> <span class="name">value</span><span class="punctuation">}</span>
<span class="name">dict_</span><span class="operator">.</span><span class="name">astName</span> <span class="operator">=</span> <span class="literal string">'Dict'</span>
</pre>
<p>The <tt class="docutils literal">astAttrs</tt> attribute defines&#8230;the attributes you want collected in the <span class="caps">AST</span>. <tt class="docutils literal">func.astName</tt> defaults to the function name, and is used as the name for the resulting <span class="caps">AST</span> Class&nbsp;name.</p>
<p>As far as <span class="caps">AST</span> attributes go, this is about as simple as it gets: if you put a function or token as the value, it automatically collects all children matching that type for you. Otherwise, it looks for a dictionary on the other side, with the following&nbsp;keys:</p>
<blockquote>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">type:</th><td class="field-body">rule or token <em>this is the only required parameter</em></td>
</tr>
<tr class="field"><th class="field-name">single:</th><td class="field-body">bool; <em>grab only the first child of that type (default:</em> <tt class="docutils literal">False</tt> <em>)</em></td>
</tr>
<tr class="field"><th class="field-name">start:</th><td class="field-body">int</td>
</tr>
<tr class="field"><th class="field-name">end:</th><td class="field-body">int; <em>start and end are for slicing &#8212; e.g. only grab the first three IDs. start can also be used in conjunction with</em> <tt class="docutils literal">single:True</tt> <em>to get a child other than the first.</em></td>
</tr>
</tbody>
</table>
</blockquote>
<p>And&#8230; that&#8217;s all I&#8217;ll put down. Be back soon to preview the actual translation&nbsp;process.</p>
</div>
</div>

</article>

<div class="post-comments">
    <a name="comments"></a>
    <script>
        var disqus_identifier = "announcing-codetalker";
    </script>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
    /**
    * var disqus_identifier; [Optional but recommended: Define a unique
    * identifier (e.g. post id or slug) for this thread] 
    */
    (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://jaredforsyth.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=jaredforsyth">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

</div>
</div>  </body>
</html>